@page "/logtrail"
@using Flurl.Http
@using Mana.Models
@using Microsoft.Extensions.Options
@inject IOptions<ManaConfiguration> Config

<PageTitle>Logtrail</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Logtrail</MudText>

<MudDataGrid T="LogEntry" Items="@_elements" Filterable="true" ReadOnly="true" Dense="true">
	<Columns>
		<Column T="LogEntry" Field="Timestamp" Title="Timestamp" StickyLeft="true"/>
		<Column T="LogEntry" Field="LoggerName" Title="Logger"/>
		<Column T="LogEntry" Field="Level" Title="Level"/>
		<Column T="LogEntry" Field="Message" Title="Message"/>
	</Columns>
</MudDataGrid>


@code {
	private IEnumerable<LogEntry> _elements = new List<LogEntry>();

	protected override async Task OnInitializedAsync()
	{
		await base.OnInitializedAsync();

		var query = SearchQuery.BuildQuery(DateTime.UtcNow.AddDays(-10), DateTime.UtcNow);

		var url = new Uri(new Uri(Config.Value.ServerUrl), new Uri("/es/_search", UriKind.Relative));

		var result = await url
			.WithBasicAuth(Config.Value.Username, Config.Value.Password)
			.PostStringAsync(query)
			.ReceiveJson<SearchResult>();
			
		_elements = result.Hits.Hits.Select(LogEntry.FromSearchHit).ToList();
	}
}